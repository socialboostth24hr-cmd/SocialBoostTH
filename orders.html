/* =========================
   ORDERS.GS
   ใช้กับระบบ Wallet (B)
   ========================= */

/**
 * GET : ดึงออเดอร์ของผู้ใช้
 * action=getOrders
 */
function getOrders(e) {
  const userId = e.parameter.user_id;
  if (!userId) return error_("MISSING_USER_ID");

  const sh = SpreadsheetApp.getActive().getSheetByName("orders");
  if (!sh) return error_("ORDERS_SHEET_NOT_FOUND");

  const rows = sh.getDataRange().getValues().slice(1);

  const orders = rows
    .filter(r => String(r[1]) === String(userId))
    .map(r => ({
      order_id: r[0],
      user_id: r[1],
      service_id: r[2],
      qty: Number(r[3]),
      price_per_100: Number(r[4]),
      discount: Number(r[5]),
      final_total: Number(r[6]),
      link: r[7],
      comment_text: r[8] || "",
      datetime: r[9],
      status: r[10],
      start_amount: r[11] || "",
      end_amount: r[12] || ""
    }));

  return success_({ orders });
}

/**
 * POST : สร้างออเดอร์ใหม่
 * action=createOrder
 */
function createOrder(data) {
  const {
    user_id,
    service_id,
    qty,
    link,
    comment_text
  } = data;

  if (!user_id || !service_id || !qty || !link) {
    return error_("MISSING_REQUIRED_FIELDS");
  }

  // ตรวจ link เบื้องต้น
  if (!/^https?:\/\//i.test(link)) {
    return error_("INVALID_LINK_FORMAT");
  }

  const ss = SpreadsheetApp.getActive();
  const shUsers   = ss.getSheetByName("users");
  const shOrders  = ss.getSheetByName("orders");
  const shWallet  = ss.getSheetByName("wallet");
  const shServices= ss.getSheetByName("services");
  const shDiscount= ss.getSheetByName("discounts");

  /* ---------- USER ---------- */
  const users = shUsers.getDataRange().getValues();
  const uRowIndex = users.findIndex(r => String(r[0]) === String(user_id));
  if (uRowIndex < 1) return error_("USER_NOT_FOUND");

  let credit = Number(users[uRowIndex][4]);
  if (credit <= 0) return error_("NO_CREDIT");

  /* ---------- SERVICE ---------- */
  const services = shServices.getDataRange().getValues().slice(1);
  const s = services.find(r => r[0] === service_id && r[15] === "on");
  if (!s) return error_("SERVICE_NOT_FOUND");

  const minQty = Number(s[3]);
  const basePrice100 = Number(s[4]);

  if (qty < minQty) return error_("QTY_LESS_THAN_MIN");

  let pricePerUnit = basePrice100 / 100;
  let discountPercent = 0;

  /* ---------- DISCOUNT ---------- */
  if (shDiscount) {
    const discounts = shDiscount.getDataRange().getValues().slice(1);
    discounts.forEach(r => {
      if (
        r[0] === service_id &&
        qty >= Number(r[1]) &&
        qty <= Number(r[2])
      ) {
        discountPercent = Number(r[3]);
        pricePerUnit = Number(r[4]) / 100;
      }
    });
  }

  const finalTotal = Number((qty * pricePerUnit).toFixed(2));

  // ห้ามติดลบ
  if (credit < finalTotal) {
    return error_("INSUFFICIENT_BALANCE");
  }

  /* ---------- CREATE ORDER ---------- */
  const orderId = "OD" + Date.now();
  const now = new Date();

  shOrders.appendRow([
    orderId,          // A order_id
    user_id,          // B user_id
    service_id,       // C service_id
    qty,              // D qty
    basePrice100,     // E price_per_100
    discountPercent,  // F discount
    finalTotal,       // G final_total
    link,             // H link
    comment_text || "", // I comments (ใช้เฉพาะบริการ comment)
    now,              // J datetime
    "pending",        // K status
    "",               // L start_amount
    ""                // M end_amount
  ]);

  /* ---------- WALLET ---------- */
  const newBalance = Number((credit - finalTotal).toFixed(2));

  // update credit users
  shUsers.getRange(uRowIndex + 1, 5).setValue(newBalance);

  // wallet log
  if (shWallet) {
    shWallet.appendRow([
      "WL" + Date.now(),
      user_id,
      "USE_ORDER",
      -finalTotal,
      "ORDER",
      newBalance,
      now
    ]);
  }

  return success_({
    order_id: orderId,
    final_total: finalTotal,
    balance_after: newBalance
  });
}