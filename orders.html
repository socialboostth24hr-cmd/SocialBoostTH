<script>
/* ===== CONFIG (API ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏ß‡πá‡∏ö) ===== */
const API = "https://script.google.com/macros/s/AKfycbz8Nzxgyvf04CmoKCmYd8WnCm5Ecp539a7viDfo8MtqHREBcSZXapZc7_PvvcvSxUVO8A/exec";
const API_KEY = "SBTH-SECURE-2026";

/* ===== AUTH ===== */
const userId = localStorage.getItem('user_id');
if(!userId){
  location.href='login.html';
  return;
}

/* ===== DOM ===== */
const box = document.getElementById('orders');
const updateText = document.getElementById('updateText');
const servicesCache = {};
let loading = false;

/* ===== MENU ===== */
function openMenu(){sideMenu.classList.add('open');menuOverlay.style.display='block'}
function closeMenu(){sideMenu.classList.remove('open');menuOverlay.style.display='none'}
function logout(){localStorage.clear();location.href='login.html'}
function goBack(){history.length>1?history.back():location.href='services.html'}

function statusText(s){
  if(s==='pending')return'‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
  if(s==='processing')return'üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
  if(s==='success')return'‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
  if(s==='cancel')return'‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
  return '-';
}

/* ===== LOAD SERVICES (‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) ===== */
async function loadServices(){
  if(Object.keys(servicesCache).length) return;
  const res = await fetch(`${API}?action=services&api_key=${API_KEY}&_=${Date.now()}`);
  const list = await res.json();
  if(Array.isArray(list)){
    list.forEach(s=>servicesCache[s.service_id]=s.display_name);
  }
}

/* ===== LOAD ORDERS ===== */
async function loadOrders(){
  if(loading) return;
  loading = true;
  updateText.innerText='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...';
  box.innerHTML='';

  try{
    await loadServices();
    const res = await fetch(`${API}?action=orders&api_key=${API_KEY}&user_id=${userId}&_=${Date.now()}`);
    const list = await res.json();

    if(!Array.isArray(list) || !list.length){
      box.innerHTML='<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</div>';
      updateText.innerText='‚Äî';
      return;
    }

    list.reverse().forEach(o=>{
      box.insertAdjacentHTML('beforeend',`
        <div class="order" onclick="openDetail('${o.order_id}')">
          <div class="row">
            <div class="order-id">${o.order_id}</div>
            <div class="amount">${Number(o.final_total||0).toFixed(2)} ‡∏ö‡∏≤‡∏ó</div>
          </div>
          <div class="row"><div>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div><div>${servicesCache[o.service_id]||o.service_id}</div></div>
          <div class="row"><div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div><div>${o.qty}</div></div>
          <div class="row"><div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div><div>${new Date(o.datetime).toLocaleString()}</div></div>
          <div class="status ${o.status}">${statusText(o.status)}</div>
        </div>
      `);
    });

    updateText.innerText='‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: '+new Date().toLocaleTimeString();
  }catch(e){
    console.error(e);
    box.innerHTML='<div class="error">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
    updateText.innerText='‚Äî';
  }finally{
    loading = false;
  }
}

function openDetail(id){
  localStorage.setItem('order_id',id);
  location.href='order-detail.html';
}

/* INIT */
loadOrders();
setInterval(loadOrders,15000);
</script>