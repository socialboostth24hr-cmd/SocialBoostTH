<script>
document.addEventListener('DOMContentLoaded', () => {

  /* ================= CONFIG ================= */
  const API = "https://script.google.com/macros/s/AKfycbxd3FO7ZHfOHDGDgVQNI1Uf3Owtmh8wXE1-00O2UimH6tA8k83PkqKItfo0_q-22sMeuQ/exec";
  const API_KEY = "SBTH-SECURE-2026";

  /* ================= AUTH (‡πÅ‡∏Å‡πâ‡∏à‡∏≠‡∏Ç‡∏≤‡∏ß) ================= */
  // üî• ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ user_id ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
  const userId = localStorage.getItem('user_id') || 'U001';

  /* ================= DOM ================= */
  const creditEl   = document.getElementById('credit');
  const box        = document.getElementById('services');
  const sideMenu   = document.getElementById('sideMenu');
  const menuOverlay= document.getElementById('menuOverlay');

  if (!box) {
    document.body.innerHTML = '<h3 style="text-align:center;color:red">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö #services</h3>';
    return;
  }

  /* ================= MENU ================= */
  window.openMenu = () => {
    sideMenu?.classList.add('open');
    if (menuOverlay) menuOverlay.style.display = 'block';
  };

  window.closeMenu = () => {
    sideMenu?.classList.remove('open');
    if (menuOverlay) menuOverlay.style.display = 'none';
  };

  window.logout = () => {
    localStorage.clear();
    location.reload();
  };

  /* ================= LOAD CREDIT ================= */
  function loadCredit() {
    if (!creditEl) return;

    fetch(`${API}?action=getUser&user_id=${userId}&api_key=${API_KEY}`)
      .then(r => r.json())
      .then(u => {
        creditEl.innerText = u && !u.error
          ? Number(u.credit || 0).toFixed(2)
          : '0.00';
      })
      .catch(() => {
        creditEl.innerText = '0.00';
      });
  }

  /* ================= LOAD SERVICES ================= */
  function loadServices() {
    box.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£...';

    fetch(`${API}?action=services&api_key=${API_KEY}`)
      .then(r => r.json())
      .then(list => {
        box.innerHTML = '';

        if (!Array.isArray(list) || !list.length) {
          box.innerHTML = '<div style="text-align:center;color:#94a3b8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>';
          return;
        }

        list.forEach(s => {
          box.insertAdjacentHTML('beforeend', `
            <div class="service">
              ${s.badge_status === 'on'
                ? `<div class="badge ${s.badge_type}">${s.badge_text || ''}</div>`
                : ''}

              <div class="service-name">${s.display_name}</div>
              <div class="service-desc">${s.short_desc || ''}</div>

              <div class="bottom">
                <div class="price">
                  ${s.price_per_100} ‡∏ö‡∏≤‡∏ó
                  <span>/ 100 ${s.unit}</span>
                  <span>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ${s.min_qty} ${s.unit}</span>
                </div>

                <button class="btn" data-id="${s.service_id}">
                  ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à
                </button>
              </div>
            </div>
          `);
        });

        box.querySelectorAll('.btn').forEach(btn => {
          btn.onclick = () => {
            localStorage.setItem('service_id', btn.dataset.id);
            location.href = 'order.html';
          };
        });
      })
      .catch(err => {
        console.error(err);
        box.innerHTML = '<div style="text-align:center;color:red">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
      });
  }

  /* ================= INIT ================= */
  loadCredit();
  loadServices();

});
</script>