<script>
/* CONFIG – ใช้ script ตัวล่าสุดตัวเดียว */
const API="https://script.google.com/macros/s/AKfycbxd3FO7ZHfOHDGDgVQNI1Uf3Owtmh8wXE1-00O2UimH6tA8k83PkqKItfo0_q-22sMeuQ/exec";
const API_KEY="SBTH-SECURE-2026";

const userId = localStorage.getItem('user_id');
if(!userId) location.href='login.html';

const creditEl = document.getElementById('credit');
const box = document.getElementById('services');

/* MENU */
function openMenu(){
  sideMenu.classList.add('open');
  menuOverlay.style.display='block';
}
function closeMenu(){
  sideMenu.classList.remove('open');
  menuOverlay.style.display='none';
}
function logout(){
  localStorage.clear();
  location.href='login.html';
}

/* ✅ LOAD CREDIT – แหล่งเดียวที่ถูกต้อง */
function loadCredit(){
  fetch(`${API}?action=getUser&user_id=${userId}&api_key=${API_KEY}&_=${Date.now()}`)
    .then(r=>r.json())
    .then(u=>{
      if(u.error) {
        creditEl.innerText = '0.00';
        return;
      }
      creditEl.innerText = Number(u.credit).toFixed(2);
      localStorage.setItem('credit', u.credit);
    })
    .catch(()=>{
      creditEl.innerText = '0.00';
    });
}

/* LOAD SERVICES */
function loadServices(){
  fetch(`${API}?action=services&api_key=${API_KEY}&_=${Date.now()}`)
    .then(r=>r.json())
    .then(list=>{
      box.innerHTML='';
      if(!Array.isArray(list)) return;

      list.forEach(s=>{
        box.innerHTML += `
          <div class="service">
            ${s.badge_status==='on'
              ? `<div class="badge ${s.badge_type}">${s.badge_text||''}</div>`
              : ''}

            <div class="service-name">${s.display_name}</div>
            <div class="service-desc">${s.short_desc||''}</div>

            <div class="bottom">
              <div class="price">
                ${s.price_per_100} บาท
                <span>/ 100 ${s.unit}</span>
                <span>ขั้นต่ำ ${s.min_qty} ${s.unit}</span>
              </div>

              <button class="btn" onclick="selectService('${s.service_id}')">
                เลือกแพ็กเกจ
              </button>
            </div>
          </div>
        `;
      });
    });
}

function selectService(id){
  localStorage.setItem('service_id', id);
  location.href='order.html';
}

function reloadAll(){
  loadCredit();
  loadServices();
}

/* INIT */
reloadAll();
</script>