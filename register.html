const SPREADSHEET_ID = SpreadsheetApp.getActiveSpreadsheet().getId();

function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  const action = data.action;

  if (action === "register") {
    return registerUser(data);
  }

  return output({ success: false, message: "Invalid action" });
}

function registerUser(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName("users");

  if (!sheet) {
    return output({ success: false, message: "ไม่พบชีต users" });
  }

  const userId = "U" + Date.now();

  sheet.appendRow([
    userId,
    data.firstname,
    data.lastname,
    data.bank,
    data.bank_account,
    data.email,
    data.password,
    0,
    new Date()
  ]);

  return output({
    success: true,
    message: "สมัครสมาชิกสำเร็จ",
    user_id: userId
  });
}

function doGet() {
  return output({
    success: true,
    message: "SocialBoostTH API Ready"
  });
}

function output(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
function register(){
  const data = {
    action: "register",
    firstname: firstname.value,
    lastname: lastname.value,
    bank: bank.value,
    bank_account: bank_account.value,
    email: email.value,
    password: password.value
  };

  fetch(API_URL,{
    method:"POST",
    body: JSON.stringify(data)
  })
  .then(r=>r.json())
  .then(res=>{
    msg.innerText = res.message;
    msg.style.color = res.success ? "#22c55e" : "#f87171";
  })
  .catch(()=>{
    msg.innerText = "เชื่อมต่อระบบไม่ได้";
    msg.style.color = "#f87171";
  });
}
