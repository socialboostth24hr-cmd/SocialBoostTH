<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>สั่งซื้อบริการ | SocialBoostTH</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#0b0f1a;
  --card:#020617;
  --blue:#38bdf8;
  --purple:#8b5cf6;
  --pink:#ec4899;
  --muted:#94a3b8;
  --success:#22c55e;
  --danger:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:linear-gradient(180deg,#020617,var(--bg));
  color:#f8fafc;
}

/* HEADER */
.header{
  position:sticky;top:0;z-index:10;
  display:flex;align-items:center;gap:10px;
  padding:14px 16px;
  background:rgba(2,6,23,.9);
  backdrop-filter:blur(12px);
}
.back{
  border:none;
  padding:6px 14px;
  border-radius:999px;
  background:#020617;
  color:#fff;
  font-weight:900;
}
.title{
  font-weight:900;
  background:linear-gradient(90deg,var(--blue),var(--purple),var(--pink));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

/* CONTAINER */
.container{
  max-width:760px;
  margin:auto;
  padding:18px 16px 140px;
}

/* CARD */
.card{
  background:var(--card);
  border:1px solid rgba(255,255,255,.08);
  border-radius:20px;
  padding:18px;
  margin-bottom:16px;
}

/* FORM */
label{
  font-size:13px;
  font-weight:800;
  display:block;
  margin-bottom:6px;
}
input, textarea{
  width:100%;
  border:none;
  outline:none;
  padding:14px;
  border-radius:14px;
  background:#020617;
  color:#fff;
  margin-bottom:14px;
  font-size:14px;
}
textarea{min-height:120px;resize:vertical}

.note{
  font-size:12px;
  color:var(--muted);
  margin-top:-8px;
  margin-bottom:14px;
}

/* SUMMARY */
.summary{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  font-size:14px;
}
.summary div span{color:var(--muted)}

/* BUTTON */
.btn{
  width:100%;
  border:none;
  padding:18px;
  border-radius:999px;
  font-size:16px;
  font-weight:900;
  color:#fff;
  background:linear-gradient(135deg,var(--blue),var(--purple),var(--pink));
  cursor:pointer;
}
.error{
  text-align:center;
  color:var(--danger);
  font-weight:900;
  margin-top:12px;
}
</style>
</head>

<body>

<header class="header">
  <button class="back" onclick="location.href='services.html'">←</button>
  <div class="title">สั่งซื้อบริการ</div>
</header>

<div class="container">

  <!-- SERVICE INFO -->
  <div class="card" id="serviceBox">
    ⏳ กำลังโหลดข้อมูลบริการ…
  </div>

  <!-- ORDER FORM -->
  <div class="card">
    <label>ลิงก์ที่ต้องการสั่ง</label>
    <input id="link" placeholder="https://www.tiktok.com/@username">
    <div class="note">รองรับเฉพาะลิงก์ TikTok ที่ถูกต้อง</div>

    <label>จำนวน</label>
    <input id="qty" type="number" min="1" placeholder="เช่น 100">

    <!-- COMMENT (เฉพาะบริการคอมเมนต์) -->
    <div id="commentBox" style="display:none">
      <label>คอมเมนต์ (1 บรรทัด = 1 คอมเมนต์)</label>
      <textarea id="comments" placeholder="พิมพ์ 1 คอมเมนต์ต่อ 1 บรรทัด"></textarea>
      <div class="note">จำนวนบรรทัด: <b id="commentCount">0</b></div>
    </div>
  </div>

  <!-- SUMMARY -->
  <div class="card">
    <div class="summary">
      <div><span>ราคาต่อหน่วย:</span> <b id="priceUnit">-</b></div>
      <div><span>ยอดรวม:</span> <b id="total">-</b></div>
    </div>
  </div>

  <button class="btn" onclick="submitOrder()">ยืนยันสั่งซื้อ</button>
  <div class="error" id="error"></div>

</div>

<script>
/* ===== CONFIG ===== */
const API_BASE = "https://script.google.com/macros/s/AKfycbwOyS7QmjMMLvomajpk0gJgPmW5wlgwjQ2qmbfQ_e5XGX1D5YYmQ8zeUB_WFti5k6zNKg/exec";
const API_KEY  = "SBTH-SECURE-2026";

/* AUTH */
const userId = localStorage.getItem("user_id");
const serviceId = localStorage.getItem("service_id");
if(!userId || !serviceId){
  location.href="services.html";
}

const box = document.getElementById("serviceBox");
const qtyEl = document.getElementById("qty");
const linkEl = document.getElementById("link");
const errEl = document.getElementById("error");

let pricePerUnit = 0;
let isCommentService = false;

/* LOAD SERVICE */
fetch(`${API_BASE}?action=getServices&api_key=${API_KEY}`)
.then(r=>r.json())
.then(res=>{
  const s = (res.services||[]).find(x=>x.service_id===serviceId);
  if(!s){
    box.innerHTML="❌ ไม่พบบริการ";
    return;
  }
  pricePerUnit = s.price_per_100 / 100;
  isCommentService = String(s.service_id).toLowerCase().includes("comment");

  box.innerHTML = `
    <b>${s.display_name}</b><br>
    <span style="color:#94a3b8">${s.short_desc||""}</span><br><br>
    ราคา ${s.price_per_100} บาท / 100 ${s.unit}
  `;

  if(isCommentService){
    document.getElementById("commentBox").style.display="block";
  }
});

/* COMMENT COUNT */
const commentArea = document.getElementById("comments");
if(commentArea){
  commentArea.addEventListener("input",()=>{
    const count = commentArea.value.split("\n").filter(l=>l.trim()).length;
    document.getElementById("commentCount").textContent = count;
  });
}

/* CALCULATE */
qtyEl.addEventListener("input",()=>{
  const q = Number(qtyEl.value||0);
  document.getElementById("priceUnit").textContent = pricePerUnit.toFixed(2)+" บาท";
  document.getElementById("total").textContent = (q*pricePerUnit).toFixed(2)+" บาท";
});

/* SUBMIT */
function submitOrder(){
  errEl.textContent="";

  const qty = Number(qtyEl.value);
  const link = linkEl.value.trim();

  if(!/^https?:\/\//i.test(link) || !link.includes("tiktok")){
    errEl.textContent="ลิงก์ไม่ถูกต้อง";
    return;
  }
  if(!qty || qty<=0){
    errEl.textContent="กรุณากรอกจำนวน";
    return;
  }

  fetch(`${API_BASE}`,{
    method:"POST",
    body:JSON.stringify({
      action:"createOrder",
      api_key:API_KEY,
      user_id:userId,
      service_id:serviceId,
      qty:qty,
      link:link,
      comment_text: isCommentService ? commentArea.value.trim() : ""
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(!res.success){
      errEl.textContent=res.error||"ทำรายการไม่สำเร็จ";
      return;
    }
    location.href="orders.html";
  })
  .catch(()=>errEl.textContent="เชื่อมต่อไม่สำเร็จ");
}
</script>

</body>
</html>