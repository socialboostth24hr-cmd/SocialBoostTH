<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>สั่งซื้อบริการ | SocialBoostTH</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* ===== STYLE (เหมือนของเดิม) ===== */
:root{
  --bg-main:#0b0216;
  --bg-card:#14062b;
  --border:#3b1775;
  --purple:#8b5cf6;
  --pink:#ec4899;
  --soft:rgba(255,255,255,.75);
  --green:#22c55e;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui;
  background:
    radial-gradient(1000px 500px at top,#2a0d52,transparent),
    linear-gradient(180deg,var(--bg-main),#14032a);
  color:#fff;
}
.container{
  max-width:420px;margin:30px auto;padding:26px;
  background:linear-gradient(180deg,#1a0936,var(--bg-card));
  border-radius:22px;
}
.card{
  background:rgba(255,255,255,.04);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;margin-bottom:14px;
}
input{
  width:100%;padding:14px;margin-top:8px;
  border-radius:14px;border:1px solid var(--border);
  background:#120725;color:#fff;
}
button{
  width:100%;padding:14px;border:none;border-radius:16px;
  font-weight:800;cursor:pointer;
  background:linear-gradient(90deg,var(--purple),var(--pink));
  color:#fff;
}
.back{background:#1e293b;margin-top:10px}
</style>
</head>

<body>

<script>
/* ===== AUTH GUARD ===== */
const user = JSON.parse(localStorage.getItem("user"));
if(!user){
  alert("กรุณาเข้าสู่ระบบ");
  location.href="index.html";
}
</script>

<div class="container">
  <h2>สั่งซื้อบริการ</h2>

  <div class="card">
    <b id="serviceName">-</b><br>
    ราคา <span id="unitPrice">0</span> บาท / หน่วย
  </div>

  <div class="card">
    <label>จำนวน</label>
    <input id="qty" type="number" min="1" value="1">
  </div>

  <div class="card">
    รวม <b><span id="total">0.00</span></b> บาท
  </div>

  <button onclick="submitOrder()">ยืนยันสั่งซื้อ</button>
  <button class="back" onclick="history.back()">⬅ กลับ</button>
</div>

<script>
/* ===== CONFIG ===== */
const ORDER_API =
"https://script.google.com/macros/s/AKfycbyJIauTAb7zYXuoMqPaCjHsOm2CVxT7jdLlKYvzt5-5sugBFeFFp8Qk3pbDYLvBHPoK/exec";

/* ===== LOAD SERVICE FROM localStorage ===== */
const service = JSON.parse(localStorage.getItem("selectedService"));
if(!service){
  alert("ไม่พบบริการ");
  location.href="services.html";
}

const qtyInput = document.getElementById("qty");
const totalEl = document.getElementById("total");

document.getElementById("serviceName").innerText = service.name;
document.getElementById("unitPrice").innerText = service.price;

function calc(){
  const q = Number(qtyInput.value)||0;
  totalEl.innerText = (q * service.price).toFixed(2);
}
qtyInput.oninput = calc;
calc();

/* ===== SUBMIT ORDER ===== */
function submitOrder(){
  const qty = Number(qtyInput.value)||0;
  const amount = Number(totalEl.innerText);

  if(qty < service.min){
    alert("จำนวนขั้นต่ำ " + service.min);
    return;
  }

  if(user.credit < amount){
    alert("เครดิตไม่พอ");
    location.href="topup.html";
    return;
  }

  fetch(ORDER_API,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      action:"createOrder",
      user_id:user.user_id,
      service:service.name,
      qty:qty,
      amount:amount,
      platform:"TikTok"
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(!res.success){
      alert(res.message||"สั่งซื้อไม่สำเร็จ");
      return;
    }

    user.credit = res.new_credit;
    localStorage.setItem("user",JSON.stringify(user));

    alert("✅ สั่งซื้อสำเร็จ");
    location.href="orders.html";
  })
  .catch(()=>{
    alert("❌ เชื่อมต่อเซิร์ฟเวอร์ไม่ได้");
  });
}
</script>

</body>
</html>