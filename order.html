<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>สั่งซื้อบริการ | SocialBoostTH</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#0b0f1a;
  --card:#020617;
  --blue:#38bdf8;
  --purple:#8b5cf6;
  --pink:#ec4899;
  --green:#22c55e;
  --red:#ef4444;
  --muted:#94a3b8;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:linear-gradient(180deg,#020617,var(--bg));
  color:#f8fafc;
}
.header{
  padding:16px;
  text-align:center;
  font-weight:900;
  background:linear-gradient(90deg,var(--blue),var(--purple),var(--pink));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.container{
  max-width:540px;
  margin:auto;
  padding:16px 16px 120px;
}
.card{
  background:var(--card);
  border:1px solid rgba(255,255,255,.12);
  border-radius:20px;
  padding:18px;
  margin-bottom:16px;
}
label{font-size:13px;font-weight:800}
input,textarea{
  width:100%;
  background:#020617;
  border:1px solid rgba(255,255,255,.15);
  border-radius:14px;
  padding:14px;
  color:#fff;
  margin-top:8px;
}
textarea{min-height:120px}
.price-row{
  display:flex;
  justify-content:space-between;
  font-size:14px;
  margin-top:8px;
}
.price-row b{color:var(--green)}
.btn{
  position:fixed;
  bottom:16px;
  left:50%;
  transform:translateX(-50%);
  width:calc(100% - 32px);
  max-width:420px;
  padding:16px;
  border-radius:999px;
  background:linear-gradient(135deg,var(--blue),var(--purple),var(--pink));
  color:#fff;
  font-weight:900;
  font-size:16px;
  border:none;
}
.error{color:var(--red);font-size:13px;margin-top:8px}
.hidden{display:none}
</style>
</head>

<body>

<div class="header">ยืนยันการสั่งซื้อ</div>

<div class="container">

  <div class="card">
    <b id="serviceName">-</b>
    <div class="price-row"><span>ขั้นต่ำ</span><span id="minQty">-</span></div>
  </div>

  <div class="card">
    <label>จำนวน</label>
    <input id="qty" type="number" min="1">
    <div class="error" id="qtyErr"></div>
  </div>

  <div class="card">
    <label>ลิงก์</label>
    <input id="link" placeholder="https://www.tiktok.com/@username">
    <div class="error" id="linkErr"></div>
  </div>

  <div class="card hidden" id="commentBox">
    <label>คอมเมนต์ (1 บรรทัด = 1 คอมเมนต์)</label>
    <textarea id="comments"></textarea>
    <div class="price-row">
      <span>จำนวนคอมเมนต์</span>
      <b id="commentCount">0</b>
    </div>
  </div>

  <div class="card">
    <div class="price-row"><span>ราคาปกติ</span><span id="priceNormal">-</span></div>
    <div class="price-row"><span>ส่วนลด</span><span id="priceDiscount">-</span></div>
    <div class="price-row"><b>จ่ายจริง</b><b id="priceFinal">-</b></div>
  </div>

</div>

<button class="btn" onclick="submitOrder()">ยืนยันสั่งซื้อ</button>

<script>
/* ===== CONFIG ===== */
const API_BASE = "https://script.google.com/macros/s/AKfycbwOyS7QmjMMLvomajpk0gJgPmW5wlgwjQ2qmbfQ_e5XGX1D5YYmQ8zeUB_WFti5k6zNKg/exec";
const API_KEY  = "SBTH-SECURE-2026";

/* AUTH */
const user_id = localStorage.getItem("user_id");
const service_id = localStorage.getItem("service_id");
if(!user_id || !service_id) location.href="services.html";

/* ELEMENT */
const elQty = document.getElementById("qty");
const elLink = document.getElementById("link");
const elComments = document.getElementById("comments");

/* STATE */
let service=null, discountRules=[], finalTotal=0;

/* LOAD SERVICE */
fetch(`${API_BASE}?action=getServices&api_key=${API_KEY}`)
.then(r=>r.json())
.then(res=>{
  service = res.services.find(s=>s.service_id===service_id);
  if(!service) location.href="services.html";
  document.getElementById("serviceName").textContent=service.display_name;
  document.getElementById("minQty").textContent=service.min_qty;
  if(service.service_type==="comment"){
    document.getElementById("commentBox").classList.remove("hidden");
  }
});

/* COMMENT COUNT */
elComments?.addEventListener("input",()=>{
  const count = elComments.value.split("\n").filter(l=>l.trim()).length;
  document.getElementById("commentCount").textContent=count;
  elQty.value=count;
  calcPrice();
});

/* PRICE CALC */
elQty.addEventListener("input",calcPrice);

function calcPrice(){
  const qty = Number(elQty.value);
  if(!qty || qty < service.min_qty){
    finalTotal=0;
    return;
  }
  let pricePerUnit = service.price_per_100 / 100;
  let normal = qty * pricePerUnit;
  finalTotal = normal;

  document.getElementById("priceNormal").textContent = normal.toFixed(2)+" บาท";
  document.getElementById("priceDiscount").textContent = "—";
  document.getElementById("priceFinal").textContent = finalTotal.toFixed(2)+" บาท";
}

/* SUBMIT */
function submitOrder(){
  document.getElementById("linkErr").textContent="";
  if(!/^https?:\/\//i.test(elLink.value)){
    document.getElementById("linkErr").textContent="ลิงก์ไม่ถูกต้อง";
    return;
  }
  fetch(API_BASE,{
    method:"POST",
    body:JSON.stringify({
      action:"createOrder",
      api_key:API_KEY,
      user_id,
      service_id,
      qty:Number(elQty.value),
      link:elLink.value,
      comment_text:elComments?.value||""
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(!res.success) throw res;
    location.href="orders.html";
  })
  .catch(e=>alert(e.error||"สั่งซื้อไม่สำเร็จ"));
}
</script>

</body>
</html>