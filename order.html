<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>สั่งซื้อบริการ | SocialBoostTH</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#0b0f1a;
  --card:#020617;
  --blue:#38bdf8;
  --purple:#8b5cf6;
  --pink:#ec4899;
  --muted:#94a3b8;
  --danger:#ef4444;
  --success:#22c55e;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:linear-gradient(180deg,#020617,var(--bg));
  color:#f8fafc;
}

.header{
  position:sticky;top:0;z-index:10;
  background:rgba(2,6,23,.9);
  backdrop-filter:blur(12px);
  padding:14px 16px;
  font-weight:900;
  text-align:center;
  background:linear-gradient(90deg,var(--blue),var(--purple));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

.container{
  max-width:520px;
  margin:auto;
  padding:20px 16px 140px;
}

.card{
  background:var(--card);
  border:1px solid rgba(255,255,255,.12);
  border-radius:20px;
  padding:18px;
  margin-bottom:16px;
}

label{
  font-size:13px;
  font-weight:900;
}

input, textarea{
  width:100%;
  margin-top:6px;
  padding:14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:#020617;
  color:#fff;
  font-size:14px;
}

textarea{
  resize:none;
  min-height:120px;
}

.hint{
  font-size:12px;
  color:var(--muted);
  margin-top:6px;
}

.summary{
  font-size:14px;
}
.summary div{
  display:flex;
  justify-content:space-between;
  margin-top:6px;
}

.total{
  font-size:18px;
  font-weight:900;
  color:var(--success);
}

.error{
  color:var(--danger);
  font-weight:900;
  font-size:13px;
  text-align:center;
}

.btn{
  position:fixed;
  bottom:16px;
  left:50%;
  transform:translateX(-50%);
  width:calc(100% - 32px);
  max-width:480px;
  padding:16px;
  border-radius:999px;
  border:none;
  font-size:16px;
  font-weight:900;
  color:#fff;
  background:linear-gradient(135deg,var(--blue),var(--purple),var(--pink));
}
</style>
</head>

<body>

<div class="header">สั่งซื้อบริการ</div>

<div class="container">

  <div class="card">
    <label>ลิงก์ที่ต้องการ</label>
    <input id="link" placeholder="https://www.tiktok.com/@username">
    <div class="hint">รองรับลิงก์ http / https เท่านั้น</div>
  </div>

  <div class="card">
    <label>จำนวน</label>
    <input id="qty" type="number" min="1">
    <div class="hint" id="minHint"></div>
  </div>

  <div class="card" id="commentBox" style="display:none">
    <label>คอมเมนต์ (1 บรรทัด = 1 คอมเมนต์)</label>
    <textarea id="comments" placeholder="พิมพ์ทีละบรรทัด"></textarea>
    <div class="hint">จำนวนคอมเมนต์: <b id="commentCount">0</b></div>
  </div>

  <div class="card summary">
    <div><span>ราคา</span><span id="price">-</span></div>
    <div><span>ส่วนลด</span><span id="discount">-</span></div>
    <div class="total"><span>รวมทั้งสิ้น</span><span id="total">-</span></div>
  </div>

  <div class="error" id="error"></div>

</div>

<button class="btn" onclick="submitOrder()">สั่งซื้อ</button>

<script>
/* ===== CONFIG ===== */
const API = "https://script.google.com/macros/s/AKfycbwOyS7QmjMMLvomajpk0gJgPmW5wlgwjQ2qmbfQ_e5XGX1D5YYmQ8zeUB_WFti5k6zNKg/exec";
const API_KEY = "SBTH-SECURE-2026";

/* ===== STATE ===== */
const userId    = localStorage.getItem("user_id");
const serviceId = localStorage.getItem("service_id");
let serviceData = null;

if(!userId || !serviceId){
  location.href="services.html";
}

/* ===== DOM ===== */
const qtyEl = document.getElementById("qty");
const linkEl = document.getElementById("link");
const errorEl = document.getElementById("error");

/* ===== LOAD SERVICE ===== */
fetch(`${API}?action=getServices&api_key=${API_KEY}`)
.then(r=>r.json())
.then(res=>{
  serviceData = res.services.find(s=>s.service_id===serviceId);
  if(!serviceData){
    errorEl.textContent="ไม่พบบริการ";
    return;
  }

  document.getElementById("minHint").textContent =
    "ขั้นต่ำ " + serviceData.min_qty + " " + serviceData.unit;

  if(serviceData.service_type==="COMMENT"){
    document.getElementById("commentBox").style.display="block";
  }
});

qtyEl.addEventListener("input",calculate);
document.getElementById("comments").addEventListener("input",()=>{
  const lines = document.getElementById("comments").value.split("\n").filter(x=>x.trim());
  document.getElementById("commentCount").textContent = lines.length;
  qtyEl.value = lines.length;
  calculate();
});

function calculate(){
  if(!serviceData) return;
  const qty = Number(qtyEl.value||0);
  if(qty < serviceData.min_qty) return;

  const price = (qty * serviceData.price_per_100 / 100).toFixed(2);
  document.getElementById("price").textContent = price + " บาท";
  document.getElementById("discount").textContent = "-";
  document.getElementById("total").textContent = price + " บาท";
}

/* ===== SUBMIT ===== */
function submitOrder(){
  errorEl.textContent="";

  if(!/^https?:\/\//i.test(linkEl.value)){
    errorEl.textContent="ลิงก์ไม่ถูกต้อง";
    return;
  }

  const payload={
    api_key:API_KEY,
    action:"createOrder",
    user_id:userId,
    service_id:serviceId,
    qty:Number(qtyEl.value),
    link:linkEl.value,
    comment_text:document.getElementById("comments").value
  };

  fetch(API,{
    method:"POST",
    body:JSON.stringify(payload)
  })
  .then(r=>r.json())
  .then(res=>{
    if(!res.success){
      errorEl.textContent=res.error || "ทำรายการไม่สำเร็จ";
      return;
    }
    location.href="orders.html";
  });
}
</script>

</body>
</html>