<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>สั่งซื้อบริการ | SocialBoostTH</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --pink:#ec4899;
  --purple:#8b5cf6;
  --blue:#38bdf8;
  --red:#ef4444;
}
*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui;
  background:
    radial-gradient(900px 360px at top,#fde7f3,transparent),
    linear-gradient(180deg,#eef6ff,#ffffff);
}

.header{
  padding:14px 18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#fff;
  position:sticky;
  top:0;
}
.logo{height:34px}
.back-btn{
  border:none;
  padding:6px 14px;
  border-radius:999px;
  background:#fff;
  cursor:pointer;
  box-shadow:0 6px 18px rgba(0,0,0,.1);
}

.container{
  max-width:720px;
  margin:0 auto;
  padding:14px 18px 130px;
}

.card{
  background:#fff;
  border-radius:22px;
  padding:20px;
  margin-bottom:16px;
  box-shadow:0 20px 45px rgba(139,92,246,.18);
}

.title{font-size:22px;font-weight:900}
.desc{font-size:14px;color:#64748b}

.field{margin-top:14px}
label{font-weight:700}
input,textarea{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid #e5e7eb;
  margin-top:6px;
  font-size:15px;
}

.price-box{
  display:flex;
  justify-content:space-between;
  margin-top:10px;
}
.discount{color:#ef4444}
.total{font-size:18px;font-weight:900;margin-top:12px}
.error{color:#ef4444;margin-top:10px}

.buy-btn{
  position:fixed;
  bottom:16px;
  left:50%;
  transform:translateX(-50%);
  width:calc(100% - 32px);
  max-width:480px;
  padding:16px;
  border-radius:999px;
  border:none;
  background:linear-gradient(135deg,var(--blue),var(--purple),var(--pink));
  color:#fff;
  font-size:18px;
  font-weight:900;
  cursor:pointer;
}
.buy-btn:disabled{opacity:.6}
</style>
</head>

<body>

<header class="header">
  <button class="back-btn" onclick="history.back()">← กลับ</button>
  <img src="https://raw.githubusercontent.com/socialboostth24hr-cmd/SocialBoostTH/main/logo.png" class="logo">
</header>

<div class="container">

  <div class="card">
    <div class="title" id="serviceName">กำลังโหลด...</div>
    <div class="desc" id="serviceDesc"></div>
  </div>

  <div class="card">
    <div class="field">
      <label>จำนวน</label>
      <input type="number" id="qty">
      <div class="error" id="minText"></div>
    </div>

    <div class="field">
      <label>ลิงก์ TikTok</label>
      <textarea id="link" placeholder="เช่น https://www.tiktok.com/@username"></textarea>
    </div>

    <div class="price-box">
      <div>ราคาปกติ</div>
      <div><b id="basePrice">0</b> บาท</div>
    </div>

    <div class="price-box discount">
      <div>ส่วนลด</div>
      <div><b id="discount">0%</b></div>
    </div>

    <div class="total">
      รวมทั้งหมด: <span id="total">0</span> บาท
    </div>

    <div class="error" id="error"></div>
  </div>

  <div class="card" id="details"></div>

</div>

<button class="buy-btn" id="buyBtn">ยืนยันสั่งซื้อ</button>

<script>
const API="https://script.google.com/macros/s/AKfycbyZjZarJL7nB_zATaPk95OQNI_DqvCPj47mr7Hqnavv3BqGb5bUAMKyzAEOi-03vUsRUw/exec";

const serviceId = localStorage.getItem('service_id');
const userId    = localStorage.getItem('user_id');
const credit    = Number(localStorage.getItem('credit') || 0);

if(!serviceId || !userId){
  location.href='services.html';
}

/* DOM */
const qtyEl       = document.getElementById('qty');
const linkEl      = document.getElementById('link');
const basePriceEl = document.getElementById('basePrice');
const discountEl  = document.getElementById('discount');
const totalEl     = document.getElementById('total');
const errorEl     = document.getElementById('error');
const minTextEl   = document.getElementById('minText');
const buyBtn      = document.getElementById('buyBtn');

let service = null;
let discounts = [];
let finalTotal = 0;

/* LOAD DATA */
Promise.all([
  fetch(API+'?action=services').then(r=>r.json()),
  fetch(API+'?action=service_details&service_id='+serviceId).then(r=>r.json()),
  fetch(API+'?action=discounts&service_id='+serviceId).then(r=>r.json())
]).then(([services, details, disc])=>{
  service = services.find(s => s.service_id === serviceId);
  discounts = disc || [];

  serviceName.innerText = service.display_name;
  serviceDesc.innerText = service.short_desc || '';
  qtyEl.value = service.min_qty;
  minTextEl.innerText = `ขั้นต่ำ ${service.min_qty} ${service.unit}`;

  details.forEach(d=>{
    detailsBox.innerHTML += `
      <h4>${d.title}</h4>
      <p>${d.content.replace(/\n/g,'<br>')}</p>
    `;
  });

  calc();
});

/* CALCULATE */
qtyEl.addEventListener('input', calc);

function calc(){
  if(!service) return;

  const qty = Number(qtyEl.value);
  if(qty < service.min_qty){
    finalTotal = 0;
    totalEl.innerText = '0';
    return;
  }

  const base = (qty * Number(service.price_per_100)) / 100;
  const dis  = discounts.find(d => qty >= d.min_qty && qty <= d.max_qty);

  finalTotal = dis
    ? qty * Number(dis.price)
    : base;

  basePriceEl.innerText = base.toFixed(2);
  discountEl.innerText  = (dis ? dis.discount_percent : 0) + '%';
  totalEl.innerText     = finalTotal.toFixed(2);
}

/* SUBMIT */
buyBtn.onclick = () => {
  errorEl.innerText = '';

  const qty  = Number(qtyEl.value);
  const link = linkEl.value.trim();

  if(qty < service.min_qty) return errorEl.innerText='จำนวนต่ำกว่าขั้นต่ำ';
  if(!link) return errorEl.innerText='กรุณากรอกลิงก์';
  if(finalTotal > credit) return errorEl.innerText='เครดิตไม่พอ';

  buyBtn.disabled = true;

  fetch(API,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      action: 'create_order',
      user_id: userId,
      service_id: serviceId,
      qty: qty,
      link: link
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(!res.success) throw res;
    localStorage.removeItem('credit'); // บังคับโหลดใหม่
    alert('สั่งซื้อสำเร็จ');
    location.href='orders.html';
  })
  .catch(()=>{
    errorEl.innerText='สั่งซื้อไม่สำเร็จ';
    buyBtn.disabled=false;
  });
};
</script>

</body>
</html>
