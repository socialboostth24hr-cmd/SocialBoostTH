<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>สั่งซื้อบริการ | SocialBoostTH</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:linear-gradient(180deg,#020617,#0b0f1a);
  color:#f8fafc;
}
.container{
  max-width:520px;
  margin:auto;
  padding:20px 16px 140px;
}
h1{margin:0 0 8px;font-size:24px}
.sub{font-size:13px;color:#94a3b8}

.card{
  background:#020617;
  border:1px solid rgba(255,255,255,.1);
  border-radius:18px;
  padding:16px;
  margin-top:16px;
}

label{
  font-size:13px;
  font-weight:900;
}
input{
  width:100%;
  margin-top:6px;
  padding:14px;
  border-radius:14px;
  background:#020617;
  border:1px solid rgba(255,255,255,.15);
  color:#fff;
  font-size:15px;
}

.price{
  display:flex;
  justify-content:space-between;
  font-size:15px;
  margin-top:8px;
}
.price b{font-size:18px}

.btn{
  position:fixed;
  bottom:16px;
  left:50%;
  transform:translateX(-50%);
  width:calc(100% - 32px);
  max-width:520px;
  padding:16px;
  border:none;
  border-radius:999px;
  font-size:16px;
  font-weight:900;
  background:linear-gradient(135deg,#38bdf8,#8b5cf6);
  color:#fff;
}

.msg{
  text-align:center;
  font-size:13px;
  margin-top:12px;
}
.error{color:#fb7185}
.success{color:#22c55e}
</style>
</head>

<body>

<div class="container">
  <h1>สั่งซื้อบริการ</h1>
  <div class="sub" id="serviceName">กำลังโหลด…</div>

  <div class="card">
    <label>จำนวน</label>
    <input type="number" id="qty" placeholder="กรอกจำนวน">
  </div>

  <div class="card">
    <label>ลิงก์ที่ต้องการ</label>
    <input type="text" id="link" placeholder="https://">
  </div>

  <div class="card">
    <div class="price">
      <span>ราคารวม</span>
      <b id="total">0.00</b>
    </div>
    <div class="sub" id="discountText"></div>
  </div>

  <div class="msg" id="msg"></div>
</div>

<button class="btn" onclick="submitOrder()">ยืนยันสั่งซื้อ</button>

<script>
/* ===== CONFIG ===== */
const API = "https://script.google.com/macros/s/AKfycbzasQWFnaCBZtRKSwRID-UzoTjh3ydUH60dvyckuGZ2tsEqV6dfasvArIxDFehLopm_cA/exec";
const API_KEY = "SBTH-SECURE-2026";

/* AUTH */
const userId = localStorage.getItem("user_id");
const serviceId = localStorage.getItem("service_id");
if(!userId || !serviceId){
  location.replace("services.html");
}

const elQty = document.getElementById("qty");
const elLink = document.getElementById("link");
const elTotal = document.getElementById("total");
const elMsg = document.getElementById("msg");
const elDiscount = document.getElementById("discountText");

let service = null;
let discounts = [];

/* LOAD SERVICE + DISCOUNT */
Promise.all([
  fetch(`${API}?action=getServices&api_key=${API_KEY}`).then(r=>r.text()),
  fetch(`${API}?action=getDiscounts&api_key=${API_KEY}`).then(r=>r.text())
]).then(([s,d])=>{
  const services = JSON.parse(s).services || [];
  discounts = JSON.parse(d).discounts || [];

  service = services.find(x=>x.service_id === serviceId);
  if(!service){
    elMsg.textContent = "ไม่พบบริการ";
    elMsg.className="msg error";
    return;
  }

  document.getElementById("serviceName").textContent =
    service.display_name + ` (ขั้นต่ำ ${service.min_qty})`;
});

/* PRICE CALC */
elQty.addEventListener("input", calc);

function calc(){
  const qty = Number(elQty.value);
  elDiscount.textContent = "";
  if(!qty || !service){
    elTotal.textContent = "0.00";
    return;
  }

  let base = (qty * service.price_per_100) / 100;
  let total = base;

  const d = discounts
    .filter(x=>x.service_id===serviceId && qty>=x.min_qty && qty<=x.max_qty)
    .sort((a,b)=>b.min_qty-a.min_qty)[0];

  if(d){
    if(d.price){
      total = qty * Number(d.price);
      elDiscount.textContent = "ใช้ราคาพิเศษ";
    }else if(d.discount_percent){
      total = base * (100 - Number(d.discount_percent)) / 100;
      elDiscount.textContent = `ส่วนลด ${d.discount_percent}%`;
    }
  }

  elTotal.textContent = total.toFixed(2);
}

/* SUBMIT */
function submitOrder(){
  elMsg.textContent="";
  const qty = Number(elQty.value);
  const link = elLink.value.trim();

  if(!qty || qty < Number(service.min_qty)){
    elMsg.textContent = "จำนวนไม่ถึงขั้นต่ำ";
    elMsg.className="msg error";
    return;
  }
  if(!link){
    elMsg.textContent = "กรุณาใส่ลิงก์";
    elMsg.className="msg error";
    return;
  }

  elMsg.textContent="กำลังสั่งซื้อ…";

  fetch(`${API}?action=createOrder&api_key=${API_KEY}&user_id=${userId}&service_id=${serviceId}&qty=${qty}&link=${encodeURIComponent(link)}`)
    .then(r=>r.json())
    .then(res=>{
      if(res.success){
        elMsg.textContent="สั่งซื้อสำเร็จ";
        elMsg.className="msg success";
        setTimeout(()=>location.href="dashboard.html",1200);
      }else{
        elMsg.textContent=res.error||"ไม่สามารถสั่งซื้อได้";
        elMsg.className="msg error";
      }
    })
    .catch(()=>{
      elMsg.textContent="เชื่อมต่อเซิร์ฟเวอร์ไม่ได้";
      elMsg.className="msg error";
    });
}
</script>

</body>
</html>
