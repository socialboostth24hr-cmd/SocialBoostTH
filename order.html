<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>สั่งซื้อบริการ | SocialBoostTH</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root{
  --bg:#0b0f1a;
  --card:#020617;
  --blue:#38bdf8;
  --purple:#8b5cf6;
  --pink:#ec4899;
  --muted:#94a3b8;
  --danger:#ef4444;
  --success:#22c55e;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:linear-gradient(180deg,#020617,var(--bg));
  color:#f8fafc;
}

/* HEADER */
.header{
  position:sticky;top:0;z-index:10;
  display:flex;justify-content:space-between;align-items:center;
  padding:14px 16px;
  background:rgba(2,6,23,.9);
  backdrop-filter:blur(12px);
}
.logo{
  font-weight:900;
  background:linear-gradient(90deg,var(--blue),var(--purple));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.wallet{
  font-size:13px;
  padding:6px 14px;
  border-radius:999px;
  background:#020617;
  border:1px solid rgba(255,255,255,.15);
}

/* CONTAINER */
.container{
  max-width:720px;
  margin:auto;
  padding:22px 16px 140px;
}

/* CARD */
.card{
  background:var(--card);
  border:1px solid rgba(255,255,255,.12);
  border-radius:22px;
  padding:18px;
  margin-bottom:18px;
}
h1{margin:0 0 6px;font-size:26px}
.sub{font-size:13px;color:var(--muted);margin-bottom:14px}

/* FORM */
.field{margin-bottom:16px}
label{
  display:flex;justify-content:space-between;gap:10px;
  font-size:13px;font-weight:800;margin-bottom:6px
}
label small{color:var(--muted);font-weight:600}
input,textarea,select{
  width:100%;
  background:#020617;
  border:1px solid rgba(255,255,255,.18);
  border-radius:14px;
  padding:14px;
  color:#fff;
  outline:none;
  font-size:14px;
}
textarea{min-height:120px;resize:vertical}

/* INFO */
.hint{font-size:12px;color:var(--muted)}
.err{font-size:12px;color:var(--danger);margin-top:6px;display:none}

/* SUMMARY */
.summary{
  display:grid;
  gap:8px;
  font-size:14px;
}
.row{
  display:flex;justify-content:space-between;
}
.total{
  font-size:18px;
  font-weight:900;
  color:#fff;
}

/* BUTTON */
.btn{
  width:100%;
  padding:16px;
  border:none;
  border-radius:999px;
  font-weight:900;
  font-size:16px;
  cursor:pointer;
  color:#fff;
  background:linear-gradient(135deg,var(--blue),var(--purple),var(--pink));
}
.btn:disabled{
  opacity:.4;
  cursor:not-allowed;
}

/* STATE */
.hide{display:none}
.ok{color:var(--success)}
</style>
</head>

<body>

<div class="header">
  <div class="logo">SocialBoostTH</div>
  <div class="wallet">
    เครดิต / Balance:
    <b id="wallet">0.00</b>
  </div>
</div>

<div class="container">

  <h1>สั่งซื้อบริการ</h1>
  <div class="sub">
    Order Service <small style="opacity:.6">(Single Order Page)</small>
  </div>

  <!-- SERVICE -->
  <div class="card">
    <div class="field">
      <label>
        บริการ <small>Service</small>
      </label>
      <select id="serviceSelect"></select>
    </div>

    <div class="field">
      <label>
        ลิงก์ที่ต้องการ <small>Target Link</small>
      </label>
      <input id="link" placeholder="https://www.tiktok.com/@username" />
      <div class="err" id="linkErr">ลิงก์ไม่ถูกต้อง</div>
    </div>

    <div class="field">
      <label>
        จำนวน <small>Quantity</small>
      </label>
      <input type="number" id="qty" min="1" />
      <div class="hint" id="qtyHint"></div>
    </div>

    <!-- COMMENT BOX -->
    <div class="field hide" id="commentBox">
      <label>
        คอมเมนต์ (1 บรรทัด = 1 คอมเมนต์)
        <small>Comments</small>
      </label>
      <textarea id="comments" placeholder="พิมพ์คอมเมนต์ทีละบรรทัด
เว้นบรรทัด = ไม่นับ"></textarea>
      <div class="hint">
        จำนวนคอมเมนต์ที่นับได้:
        <b id="commentCount">0</b>
      </div>
    </div>
  </div>

  <!-- SUMMARY -->
  <div class="card">
    <b>สรุปรายการ / Summary</b>
    <div class="summary" style="margin-top:10px">
      <div class="row">
        <span>ราคาปกติ</span>
        <span id="basePrice">0.00</span>
      </div>
      <div class="row">
        <span>ส่วนลด</span>
        <span id="discount">0.00</span>
      </div>
      <div class="row total">
        <span>ยอดสุทธิ</span>
        <span id="total">0.00</span>
      </div>
      <div class="row">
        <span>เครดิตคงเหลือ</span>
        <span id="remain">0.00</span>
      </div>
    </div>
  </div>

  <!-- ACTION -->
  <button class="btn" id="submitBtn" disabled>
    ยืนยันสั่งซื้อ / Place Order
  </button>

</div>

<script>
/* ================= CONFIG ================= */
const API = "https://script.google.com/macros/s/AKfycbzasQWFnaCBZtRKSwRID-UzoTjh3ydUH60dvyckuGZ2tsEqV6dfasvArIxDFehLopm_cA/exec";
const API_KEY = "SBTH-SECURE-2026";

/* ================= AUTH ================= */
const userId = localStorage.getItem("user_id");
if(!userId) location.href="login.html";

/* ================= STATE ================= */
let services = [];
let wallet = Number(localStorage.getItem("credit")||0);
document.getElementById("wallet").textContent = wallet.toFixed(2);

const elService = document.getElementById("serviceSelect");
const elQty = document.getElementById("qty");
const elLink = document.getElementById("link");
const elBtn = document.getElementById("submitBtn");

/* ================= HELPERS ================= */
function validLink(v){
  return /^https?:\/\//i.test(v) && /tiktok\.com/i.test(v);
}
function countComments(){
  const lines = document.getElementById("comments").value
    .split("\n")
    .map(v=>v.trim())
    .filter(v=>v!=="");
  document.getElementById("commentCount").textContent = lines.length;
  return lines.length;
}

/* ================= LOAD SERVICES ================= */
fetch(`${API}?action=getServices&api_key=${API_KEY}`)
.then(r=>r.json())
.then(res=>{
  services = res.services || [];
  elService.innerHTML = `<option value="">-- เลือกบริการ --</option>`;
  services.forEach(s=>{
    elService.innerHTML += `<option value="${s.service_id}">${s.display_name}</option>`;
  });
});

/* ================= CALC ================= */
function recalc(){
  const s = services.find(x=>x.service_id===elService.value);
  if(!s) return;

  let qty = Number(elQty.value||0);
  if(qty < s.min_qty) qty = 0;

  // comment-only service
  if(s.service_type==="COMMENT"){
    qty = countComments();
  }

  const pricePerUnit = s.price_per_100 / 100;
  const base = qty * pricePerUnit;
  const discount = s.discount_percent ? base * (s.discount_percent/100) : 0;
  const total = base - discount;
  const remain = wallet - total;

  document.getElementById("basePrice").textContent = base.toFixed(2);
  document.getElementById("discount").textContent = discount.toFixed(2);
  document.getElementById("total").textContent = total.toFixed(2);
  document.getElementById("remain").textContent = remain.toFixed(2);

  elBtn.disabled = !(total>0 && remain>=0 && validLink(elLink.value));
}

/* ================= EVENTS ================= */
elService.onchange = ()=>{
  const s = services.find(x=>x.service_id===elService.value);
  document.getElementById("commentBox")
    .classList.toggle("hide", s?.service_type!=="COMMENT");
  document.getElementById("qtyHint").textContent =
    s ? `ขั้นต่ำ ${s.min_qty} ${s.unit}` : "";
  recalc();
};
elQty.oninput = recalc;
elLink.oninput = ()=>{
  document.getElementById("linkErr").style.display =
    validLink(elLink.value) ? "none":"block";
  recalc();
};
document.getElementById("comments").oninput = recalc;

/* ================= SUBMIT ================= */
elBtn.onclick = ()=>{
  alert("สั่งซื้อสำเร็จ (ตัวอย่าง)\n→ redirect ไปหน้าออเดอร์ของฉัน");
  location.href="orders.html";
};
</script>

</body>
</html>