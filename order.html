/* =========================
   ORDERS.GS
   ========================= */

/**
 * สร้างออเดอร์ใหม่
 * action=createOrder (POST)
 */
function createOrder(data) {
  const ss = SpreadsheetApp.getActive();
  const shOrders = ss.getSheetByName("orders");
  const shUsers = ss.getSheetByName("users");
  const shDiscounts = ss.getSheetByName("discounts");

  const userId = data.user_id;
  const serviceId = data.service_id;
  const qty = Number(data.qty);
  const link = (data.link || "").trim();
  const commentText = data.comment_text || "";

  if (!userId || !serviceId || !qty || !link) {
    return error_("MISSING_REQUIRED_FIELDS");
  }

  // --- validate link เบื้องต้น ---
  if (!link.startsWith("http")) {
    return error_("INVALID_LINK");
  }

  // --- ดึง user ---
  const users = shUsers.getDataRange().getValues();
  const uRow = users.find(r => r[0] === userId && r[5] === "active");
  if (!uRow) return error_("USER_NOT_FOUND");

  let credit = Number(uRow[4]);

  // --- ราคาพื้นฐานจาก services ---
  const service = getServiceById_(serviceId);
  if (!service) return error_("SERVICE_NOT_FOUND");

  if (qty < service.min_qty) return error_("QTY_LESS_THAN_MIN");

  let pricePerUnit = service.price_per_100 / 100;

  // --- คำนวณส่วนลดจาก discounts ---
  let discountPercent = 0;
  const discounts = shDiscounts.getDataRange().getValues().slice(1);
  discounts.forEach(r => {
    if (r[0] === serviceId && qty >= r[1] && qty <= r[2]) {
      discountPercent = Number(r[3]);
      pricePerUnit = Number(r[4]);
    }
  });

  const rawTotal = qty * pricePerUnit;
  const finalTotal = Number(rawTotal.toFixed(2));

  // --- wallet ห้ามติดลบ ---
  if (credit < finalTotal) {
    return error_("INSUFFICIENT_BALANCE");
  }

  // --- สร้าง order ---
  const orderId = "OD" + Date.now();
  const now = new Date();

  shOrders.appendRow([
    orderId,
    userId,
    serviceId,
    qty,
    service.price_per_100,
    discountPercent,
    finalTotal,
    link,
    commentText,
    now,
    "pending",
    "",
    ""
  ]);

  // --- ตัดเครดิต + wallet log ---
  credit = credit - finalTotal;
  updateUserCredit_(userId, credit);
  createWalletLog_(userId, -finalTotal, "USE_ORDER", orderId);

  return success_({
    order_id: orderId,
    final_total: finalTotal,
    balance_after: credit
  });
}

/**
 * ดึงออเดอร์ของ user
 * action=getOrders
 */
function getOrders(e) {
  const userId = e.parameter.user_id;
  if (!userId) return error_("MISSING_USER_ID");

  const sh = SpreadsheetApp.getActive().getSheetByName("orders");
  const rows = sh.getDataRange().getValues().slice(1);

  const orders = rows
    .filter(r => r[1] === userId)
    .map(r => ({
      order_id: r[0],
      service_id: r[2],
      qty: r[3],
      final_total: r[6],
      link: r[7],
      comment_text: r[8],
      datetime: r[9],
      status: r[10]
    }));

  return success_({ orders });
}

/* =========================
   HELPERS (เฉพาะ order)
   ========================= */

function getServiceById_(serviceId) {
  const sh = SpreadsheetApp.getActive().getSheetByName("services");
  const rows = sh.getDataRange().getValues().slice(1);
  for (const r of rows) {
    if (r[0] === serviceId && r[15] === "on") {
      return {
        service_id: r[0],
        min_qty: Number(r[3]),
        price_per_100: Number(r[4])
      };
    }
  }
  return null;
}

function updateUserCredit_(userId, newCredit) {
  const sh = SpreadsheetApp.getActive().getSheetByName("users");
  const rows = sh.getDataRange().getValues();
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] === userId) {
      sh.getRange(i + 1, 5).setValue(newCredit);
      return;
    }
  }
}

function createWalletLog_(userId, amount, type, refId) {
  const sh = SpreadsheetApp.getActive().getSheetByName("topup_log");
  sh.appendRow([
    "WL" + Date.now(),
    userId,
    type,
    amount,
    refId,
    new Date()
  ]);
}