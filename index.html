<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>SocialBoostTH</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(180deg,#0b0216,#1a0438);
  color:#fff;
}
.container{
  max-width:420px;
  margin:30px auto;
  padding:24px;
  background:#120726;
  border-radius:18px;
}
h1{text-align:center;margin:0}
.sub{text-align:center;opacity:.8;margin-bottom:12px}
.box{
  background:#0f0220;
  border:1px solid #2e1065;
  padding:12px;
  border-radius:12px;
  margin-top:10px;
}
label{font-size:14px;display:block;margin-top:12px}
input,select,button{
  width:100%;
  padding:14px;
  margin-top:6px;
  border-radius:12px;
  border:1px solid #2e1065;
  background:#0f0220;
  color:#fff;
  font-size:15px;
}
button{
  margin-top:16px;
  background:linear-gradient(90deg,#7c3aed,#5b21b6);
  border:none;
  font-weight:bold;
}
.total{
  margin-top:14px;
  font-size:18px;
  text-align:center;
}
.logout{background:#111}
.msg{text-align:center;font-size:14px;opacity:.85}
</style>
</head>

<body>

<!-- ================= LOGIN ================= -->
<div class="container" id="loginBox">
  <h1>SocialBoostTH</h1>
  <div class="sub">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>

  <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
  <input id="email">

  <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
  <input id="password" type="password">

  <button onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
  <div id="loginMsg" class="msg"></div>
</div>

<!-- ================= PANEL ================= -->
<div class="container" id="panel" style="display:none">
  <h1>SocialBoostTH</h1>
  <div class="sub">‡∏™‡∏±‡πà‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>

  <div class="box">
    üë§ <b id="username"></b><br>
    üí∞ ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b id="credit"></b>
  </div>

  <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label>
  <select id="serviceSelect"></select>

  <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
  <input id="qty" type="number" value="50">

  <label>‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏á‡∏≤‡∏ô</label>
  <input id="link" placeholder="https://tiktok.com/...">

  <div id="total" class="total">‡∏£‡∏ß‡∏° 0 ‡∏ö‡∏≤‡∏ó</div>

  <button onclick="order()">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
  <button class="logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>

<script>
/* ================= CONFIG ================= */
const SHEET_ID = "10hFozE-vcdtPhX7KiGs3JTndpvxbUNDHDzhpvPxIz-4";
const USERS_API    = `https://opensheet.elk.sh/${SHEET_ID}/users`;
const SERVICES_API = `https://opensheet.elk.sh/${SHEET_ID}/services`;

/* ‚úÖ GAS URL ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤ doGet ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß */
const GAS_API =
"https://script.google.com/macros/s/AKfycby2utfzT3R0XymWtkmH41aVHVILkm5-irLcfTe2B3ETEs0Sq6KbHc8EqrFKWDS3ja3k/exec";

/* ================= STATE ================= */
let user = null;
let services = [];

/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded",()=>{
  const saved = localStorage.getItem("user");
  if(saved){
    user = JSON.parse(saved);
    showPanel();
    loadServices();
  }
});

/* ================= LOGIN ================= */
async function login(){
  loginMsg.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";

  const res = await fetch(USERS_API);
  const users = await res.json();

  const u = users.find(x =>
    x.email?.toLowerCase() === email.value.trim().toLowerCase() &&
    String(x.password).trim() === password.value.trim()
  );

  if(!u){
    loginMsg.innerText = "‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
    return;
  }

  user = {
    user_id: u.user_id,
    fullname: u.fullname,
    credit: Number(u.credit)
  };

  localStorage.setItem("user", JSON.stringify(user));
  showPanel();
  loadServices();
}

function showPanel(){
  loginBox.style.display = "none";
  panel.style.display = "block";
  username.innerText = user.fullname;
  credit.innerText   = user.credit;
}

function logout(){
  localStorage.removeItem("user");
  location.reload();
}

/* ================= LOAD SERVICES ================= */
async function loadServices(){
  serviceSelect.innerHTML = "<option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>";

  const res = await fetch(SERVICES_API);
  services = (await res.json()).filter(s => s.status === "active");

  serviceSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ --</option>`;
  services.forEach((s,i)=>{
    const o = document.createElement("option");
    o.value = i;
    o.textContent = `${s.platform} | ${s.service_name}`;
    serviceSelect.appendChild(o);
  });
}

/* ================= CALCULATE ================= */
serviceSelect.onchange = calc;
qty.oninput = calc;

function calc(){
  if(serviceSelect.value===""){
    total.innerText = "‡∏£‡∏ß‡∏° 0 ‡∏ö‡∏≤‡∏ó";
    return;
  }

  const s = services[serviceSelect.value];
  const q = Number(qty.value);

  if(q < Number(s.min_qty) || q > Number(s.max_qty)){
    total.innerText = "‚ùå ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
    return;
  }

  total.innerText = `‡∏£‡∏ß‡∏° ${(q * Number(s.price_th)).toFixed(2)} ‡∏ö‡∏≤‡∏ó`;
}

/* ================= ORDER ================= */
async function order(){
  alert("ORDER CLICKED"); // üî• ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ô‡πà

  if(serviceSelect.value===""){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£");
    return;
  }

  const s = services[serviceSelect.value];
  const q = Number(qty.value);
  const amount = q * Number(s.price_th);

  if(amount > user.credit){
    alert("‚ùå ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏û‡∏≠");
    return;
  }

  try{
    const res = await fetch(GAS_API,{
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({
        user_id: user.user_id,
        amount: amount,
        service_code: s.service_code,
        platform: s.platform,
        qty: q,
        link: link.value
      })
    });

    const text = await res.text();
    console.log("GAS RESPONSE:", text);

    const data = JSON.parse(text);

    if(!data.success){
      alert("‚ùå " + data.message);
      return;
    }

    user.credit = data.credit;
    localStorage.setItem("user", JSON.stringify(user));
    credit.innerText = data.credit;

    alert("‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\nOrder ID: " + data.order_id);

  }catch(err){
    alert("‚ùå ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
    console.error(err);
  }
}
</script>

</body>
</html>