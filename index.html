<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>SocialBoostTH</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(180deg,#0b0216,#1a0438);
  color:#fff;
}
.container{
  max-width:420px;
  margin:30px auto;
  padding:24px;
  background:#120726;
  border-radius:18px;
}
h1{text-align:center;margin:0}
.sub{
  text-align:center;
  opacity:.85;
  margin-bottom:16px;
  line-height:1.6;
}
.box{
  background:#0f0220;
  border:1px solid #2e1065;
  padding:12px;
  border-radius:12px;
  margin-top:10px;
}
label{
  font-size:14px;
  display:block;
  margin-top:12px;
}
input,select,button{
  width:100%;
  padding:14px;
  margin-top:6px;
  border-radius:12px;
  border:1px solid #2e1065;
  background:#0f0220;
  color:#fff;
  font-size:15px;
}
button{
  margin-top:14px;
  background:linear-gradient(90deg,#7c3aed,#5b21b6);
  border:none;
  font-weight:bold;
}
.logout{background:#111}
.total{text-align:center;font-size:18px;margin-top:10px}
.order{
  border-bottom:1px solid #2e1065;
  padding:12px 0;
  font-size:14px;
}
.pending{color:#facc15}
.processing{color:#38bdf8}
.completed{color:#22c55e}
.small{opacity:.7;font-size:13px}

.relative{position:relative}
.toggle-pass{
  position:absolute;
  right:14px;
  top:50%;
  transform:translateY(-50%);
  font-size:13px;
  opacity:.8;
  cursor:pointer;
}
.toggle-pass:hover{opacity:1}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="container" id="loginBox">
  <h1>SocialBoostTH</h1>
  <div class="sub">
    เข้าสู่ระบบใช้งาน<br>
    <span class="small">
      หากยังไม่มีบัญชี กรุณาติดต่อร้านทาง LINE <b>@geg4960w</b>
    </span>
  </div>

  <label>อีเมล</label>
  <input id="email" autocomplete="username">

  <label>รหัสผ่าน</label>
  <div class="relative">
    <input id="password" type="password" autocomplete="current-password">
    <span class="toggle-pass" onclick="togglePass()" id="toggleText">
      แสดงรหัสผ่าน
    </span>
  </div>

  <button onclick="login()">เข้าสู่ระบบ</button>
  <div id="loginMsg" class="small"></div>
</div>

<!-- PANEL -->
<div class="container" id="panel" style="display:none">
  <h1>SocialBoostTH</h1>
  <div class="sub">สั่งบริการ</div>

  <div class="box">
    ผู้ใช้งาน: <b id="username"></b><br>
    เครดิตคงเหลือ: <b id="credit"></b>
  </div>

  <label>เลือกบริการ</label>
  <select id="serviceSelect"></select>

  <label>จำนวน</label>
  <input id="qty" type="number" value="20">

  <label>ลิงก์งาน</label>
  <input id="link" placeholder="https://tiktok.com/...">

  <div id="total" class="total">รวม 0 บาท</div>

  <button onclick="order()">สั่งซื้อ</button>
  <button onclick="showOrders()">ดูออเดอร์ของฉัน</button>
  <button class="logout" onclick="logout()">ออกจากระบบ</button>
</div>

<!-- ORDERS -->
<div class="container" id="ordersBox" style="display:none">
  <h1>ออเดอร์ของฉัน</h1>
  <div id="ordersList" class="small">กำลังโหลด...</div>
  <button onclick="backToPanel()">กลับ</button>
</div>

<script>
/* CONFIG */
const SHEET_ID="10hFozE-vcdtPhX7KiGs3JTndpvxbUNDHDzhpvPxIz-4";
const USERS_API=`https://opensheet.elk.sh/${SHEET_ID}/users`;
const SERVICES_API=`https://opensheet.elk.sh/${SHEET_ID}/services`;
const ORDERS_API=`https://opensheet.elk.sh/${SHEET_ID}/orders`;
const GAS_API="https://script.google.com/macros/s/AKfycby2utfzT3R0XymWtkmH41aVHVILkm5-irLcfTe2B3ETEs0Sq6KbHc8EqrFKWDS3ja3k/exec";

let user=null, services=[], orderTimer=null;

/* INIT */
document.addEventListener("DOMContentLoaded",()=>{
  const s=localStorage.getItem("user");
  if(s){ user=JSON.parse(s); showPanel(); loadServices(); }
});

/* LOGIN */
async function login(){
  const users=await (await fetch(USERS_API)).json();
  const u=users.find(x =>
    x.email?.toLowerCase()===email.value.toLowerCase() &&
    String(x.password).trim()===password.value.trim()
  );
  if(!u){
    loginMsg.innerText="อีเมลหรือรหัสผ่านไม่ถูกต้อง";
    return;
  }
  user={user_id:u.user_id,fullname:u.fullname,credit:Number(u.credit)};
  localStorage.setItem("user",JSON.stringify(user));
  showPanel(); loadServices();
}

function togglePass(){
  const p=document.getElementById("password");
  const t=document.getElementById("toggleText");
  if(p.type==="password"){
    p.type="text";
    t.innerText="ซ่อนรหัสผ่าน";
  }else{
    p.type="password";
    t.innerText="แสดงรหัสผ่าน";
  }
}

function showPanel(){
  loginBox.style.display="none";
  ordersBox.style.display="none";
  panel.style.display="block";
  username.innerText=user.fullname;
  credit.innerText=user.credit;
  clearInterval(orderTimer);
}

function logout(){ localStorage.clear(); location.reload(); }

/* SERVICES */
async function loadServices(){
  services=(await (await fetch(SERVICES_API)).json()).filter(s=>s.status==="active");
  serviceSelect.innerHTML='<option value="">-- เลือกบริการ --</option>';
  services.forEach((s,i)=>{
    serviceSelect.innerHTML+=`<option value="${i}">${s.platform} | ${s.service_name}</option>`;
  });
}

serviceSelect.onchange=calc; qty.oninput=calc;
function calc(){
  if(!serviceSelect.value){ total.innerText="รวม 0 บาท"; return; }
  const s=services[serviceSelect.value], q=Number(qty.value);
  if(q<s.min_qty||q>s.max_qty){ total.innerText="จำนวนไม่ถูกต้อง"; return; }
  total.innerText=`รวม ${(q*s.price_th).toFixed(2)} บาท`;
}

/* ORDER */
async function order(){
  const s=services[serviceSelect.value], q=Number(qty.value);
  const amount=q*s.price_th;
  if(amount>user.credit){ alert("เครดิตไม่เพียงพอ"); return; }

  const res=await fetch(GAS_API,{method:"POST",body:JSON.stringify({
    user_id:user.user_id,
    service_code:s.service_code,
    platform:s.platform,
    qty:q,
    amount:amount,
    link:link.value
  })});
  const d=JSON.parse(await res.text());
  if(!d.success){ alert(d.message); return; }

  user.credit=d.credit;
  credit.innerText=d.credit;
  localStorage.setItem("user",JSON.stringify(user));
  alert("สั่งซื้อสำเร็จ");
}

/* ORDERS */
async function showOrders(){
  panel.style.display="none";
  ordersBox.style.display="block";
  await loadMyOrders();
  orderTimer=setInterval(loadMyOrders,5000);
}

async function loadMyOrders(){
  const data=await (await fetch(ORDERS_API)).json();
  const my=data.filter(o=>String(o.user_id)===String(user.user_id)).reverse();
  if(!my.length){ ordersList.innerText="ยังไม่มีออเดอร์"; return; }

  ordersList.innerHTML=my.map(o=>{
    const sv=services.find(s=>s.service_code===o.service_code);
    const name=sv ? `${sv.platform} | ${sv.service_name}` : o.service_code;
    return `
      <div class="order">
        <b>${name}</b><br>
        จำนวน: ${o.qty} | ${o.price} บาท<br>
        สถานะ: <span class="${o.status}">${o.status}</span><br>
        <span class="small">${o.created_at}</span>
      </div>
    `;
  }).join("");
}

function backToPanel(){ showPanel(); }
</script>

</body>
</html>