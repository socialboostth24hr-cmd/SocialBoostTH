<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>SocialBoostTH</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(180deg,#0b0216,#1a0438);
  color:#fff;
}
.container{
  max-width:420px;
  margin:30px auto;
  padding:24px;
  background:#120726;
  border-radius:18px;
}
h1{text-align:center;margin:0}
.sub{text-align:center;opacity:.8;margin-bottom:12px}
.box{
  background:#0f0220;
  border:1px solid #2e1065;
  padding:12px;
  border-radius:12px;
  margin-top:10px;
}
label{font-size:14px;display:block;margin-top:12px}
input,select,button{
  width:100%;
  padding:14px;
  margin-top:6px;
  border-radius:12px;
  border:1px solid #2e1065;
  background:#0f0220;
  color:#fff;
}
button{
  margin-top:14px;
  background:linear-gradient(90deg,#7c3aed,#5b21b6);
  border:none;
  font-weight:bold;
}
.logout{background:#111}
.total{text-align:center;font-size:18px;margin-top:10px}
.order{
  border-bottom:1px solid #2e1065;
  padding:12px 0;
  font-size:14px;
}
.pending{color:#facc15}
.processing{color:#38bdf8}
.completed{color:#22c55e}
.small{opacity:.7;font-size:13px}
.toggle-pass{
  position:absolute;
  right:16px;
  top:42px;
  opacity:.7;
  cursor:pointer;
}
.relative{position:relative}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="container" id="loginBox">
  <h1>SocialBoostTH</h1>
  <div class="sub">
    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö<br>
    <span class="small">‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ üëâ ‡∏ó‡∏±‡∏Å LINE ‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏±‡∏Ñ‡∏£</span>
  </div>

  <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
  <input id="email">

  <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
  <div class="relative">
    <input id="password" type="password">
    <span class="toggle-pass" onclick="togglePass()">üëÅ</span>
  </div>

  <button onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
  <div id="loginMsg" class="small"></div>
</div>

<!-- PANEL -->
<div class="container" id="panel" style="display:none">
  <h1>SocialBoostTH</h1>
  <div class="sub">‡∏™‡∏±‡πà‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>

  <div class="box">
    üë§ <b id="username"></b><br>
    üí∞ ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b id="credit"></b>
  </div>

  <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label>
  <select id="serviceSelect"></select>

  <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
  <input id="qty" type="number" value="20">

  <label>‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏á‡∏≤‡∏ô</label>
  <input id="link">

  <div id="total" class="total">‡∏£‡∏ß‡∏° 0 ‡∏ö‡∏≤‡∏ó</div>

  <button onclick="order()">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
  <button onclick="showOrders()">üì¶ ‡∏î‡∏π‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
  <button class="logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>

<!-- ORDERS -->
<div class="container" id="ordersBox" style="display:none">
  <h1>üì¶ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h1>
  <div id="ordersList" class="small">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
  <button onclick="backToPanel()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button>
</div>

<script>
/* ===== CONFIG ===== */
const SHEET_ID="10hFozE-vcdtPhX7KiGs3JTndpvxbUNDHDzhpvPxIz-4";
const USERS_API=`https://opensheet.elk.sh/${SHEET_ID}/users`;
const SERVICES_API=`https://opensheet.elk.sh/${SHEET_ID}/services`;
const ORDERS_API=`https://opensheet.elk.sh/${SHEET_ID}/orders`;
const GAS_API="https://script.google.com/macros/s/AKfycby2utfzT3R0XymWtkmH41aVHVILkm5-irLcfTe2B3ETEs0Sq6KbHc8EqrFKWDS3ja3k/exec";

let user=null, services=[];
let orderTimer=null;

/* ===== INIT ===== */
document.addEventListener("DOMContentLoaded",()=>{
  const s=localStorage.getItem("user");
  if(s){ user=JSON.parse(s); showPanel(); loadServices(); }
});

/* ===== LOGIN ===== */
async function login(){
  const users=await (await fetch(USERS_API)).json();
  const u=users.find(x =>
    x.email?.toLowerCase()===email.value.toLowerCase() &&
    String(x.password).trim()===password.value.trim()
  );
  if(!u){ loginMsg.innerText="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"; return; }

  user={user_id:u.user_id,fullname:u.fullname,credit:Number(u.credit)};
  localStorage.setItem("user",JSON.stringify(user));
  showPanel(); loadServices();
}

function togglePass(){
  password.type = password.type === "password" ? "text" : "password";
}

function showPanel(){
  loginBox.style.display="none";
  ordersBox.style.display="none";
  panel.style.display="block";
  username.innerText=user.fullname;
  credit.innerText=user.credit;
  clearInterval(orderTimer);
}

function logout(){ localStorage.clear(); location.reload(); }

/* ===== SERVICES ===== */
async function loadServices(){
  services=(await (await fetch(SERVICES_API)).json()).filter(s=>s.status==="active");
  serviceSelect.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ --</option>';
  services.forEach((s,i)=>{
    serviceSelect.innerHTML+=`<option value="${i}">${s.platform} | ${s.service_name}</option>`;
  });
}

serviceSelect.onchange=calc; qty.oninput=calc;

function calc(){
  if(!serviceSelect.value){ total.innerText="‡∏£‡∏ß‡∏° 0 ‡∏ö‡∏≤‡∏ó"; return; }
  const s=services[serviceSelect.value], q=Number(qty.value);
  if(q<s.min_qty||q>s.max_qty){ total.innerText="‚ùå ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"; return; }
  total.innerText=`‡∏£‡∏ß‡∏° ${(q*s.price_th).toFixed(2)} ‡∏ö‡∏≤‡∏ó`;
}

/* ===== ORDER ===== */
async function order(){
  const s=services[serviceSelect.value], q=Number(qty.value);
  const amount=q*s.price_th;
  if(amount>user.credit){ alert("‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏û‡∏≠"); return; }

  const res=await fetch(GAS_API,{method:"POST",body:JSON.stringify({
    user_id:user.user_id,
    service_code:s.service_code,
    platform:s.platform,
    qty:q,
    amount:amount,
    link:link.value
  })});
  const d=JSON.parse(await res.text());
  if(!d.success){ alert(d.message); return; }

  user.credit=d.credit;
  credit.innerText=d.credit;
  localStorage.setItem("user",JSON.stringify(user));
  alert("‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
}

/* ===== ORDERS + REALTIME REFRESH ===== */
async function showOrders(){
  panel.style.display="none";
  ordersBox.style.display="block";
  await loadMyOrders();
  orderTimer=setInterval(loadMyOrders,5000); // üîÅ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥
}

async function loadMyOrders(){
  const data=await (await fetch(ORDERS_API)).json();
  const my=data.filter(o=>String(o.user_id)===String(user.user_id)).reverse();
  if(!my.length){ ordersList.innerText="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå"; return; }

  ordersList.innerHTML=my.map(o=>{
    const sv=services.find(s=>s.service_code===o.service_code);
    const name=sv ? `${sv.platform} | ${sv.service_name}` : o.service_code;
    return `
      <div class="order">
        <b>${name}</b><br>
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${o.qty} | ${o.price} ‡∏ö‡∏≤‡∏ó<br>
        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class="${o.status}">${o.status}</span><br>
        <span class="small">${o.created_at}</span>
      </div>
    `;
  }).join("");
}

function backToPanel(){ showPanel(); }
</script>

</body>
</html>