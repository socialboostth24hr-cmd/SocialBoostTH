<!-- JS -->
<script>
/* ===== CONFIG ===== */
const SHEET_ID="10hFozE-vcdtPhX7KiGs3JTndpvxbUNDHDzhpvPxIz-4";
const USERS_API=`https://opensheet.elk.sh/${SHEET_ID}/users`;
const SERVICES_API=`https://opensheet.elk.sh/${SHEET_ID}/services`;
const ORDERS_API=`https://opensheet.elk.sh/${SHEET_ID}/orders`;
const GAS_API="https://script.google.com/macros/s/AKfycby2utfzT3R0XymWtkmH41aVHVILkm5-irLcfTe2B3ETEs0Sq6KbHc8EqrFKWDS3ja3k/exec";

let user=null, services=[];
let orderTimer=null;

/* INIT */
document.addEventListener("DOMContentLoaded",()=>{
  const s=localStorage.getItem("user");
  if(s){ user=JSON.parse(s); showPanel(); loadServices(); }
});

/* LOGIN */
async function login(){
  const users=await (await fetch(USERS_API)).json();
  const u=users.find(x =>
    x.email?.toLowerCase()===email.value.trim().toLowerCase() &&
    String(x.password).trim()===password.value.trim()
  );
  if(!u){ loginMsg.innerText="อีเมลหรือรหัสผ่านไม่ถูกต้อง"; return; }

  user={user_id:u.user_id,fullname:u.fullname,credit:Number(u.credit)};
  localStorage.setItem("user",JSON.stringify(user));
  showPanel(); loadServices();
}

function togglePass(){
  password.type = password.type==="password" ? "text" : "password";
}

/* PANEL */
function showPanel(){
  loginBox.style.display="none";
  ordersBox.style.display="none";
  panel.style.display="block";
  username.innerText=user.fullname;
  credit.innerText=user.credit;
  clearInterval(orderTimer);
}

function logout(){ localStorage.clear(); location.reload(); }

/* SERVICES */
async function loadServices(){
  services=(await (await fetch(SERVICES_API)).json()).filter(s=>s.status==="active");
  serviceSelect.innerHTML='<option value="">-- เลือกบริการ --</option>';
  services.forEach((s,i)=>{
    serviceSelect.innerHTML+=`<option value="${i}">${s.platform} | ${s.service_name}</option>`;
  });
}

serviceSelect.onchange=calc;
qty.oninput=calc;

function calc(){
  if(!serviceSelect.value){ total.innerText="รวม 0 บาท"; return; }
  const s=services[serviceSelect.value], q=Number(qty.value);
  if(q<s.min_qty||q>s.max_qty){
    total.innerText="❌ จำนวนไม่ถูกต้อง";
    return;
  }
  total.innerText=`รวม ${(q*s.price_th).toFixed(2)} บาท`;
}

/* ORDER */
async function order(){
  const s=services[serviceSelect.value], q=Number(qty.value);
  const amount=q*s.price_th;
  if(amount>user.credit){ alert("เครดิตไม่พอ"); return; }

  const res=await fetch(GAS_API,{
    method:"POST",
    body:JSON.stringify({
      user_id:user.user_id,
      service_code:s.service_code,
      platform:s.platform,
      qty:q,
      amount:amount,
      link:link.value
    })
  });

  const d=JSON.parse(await res.text());
  if(!d.success){ alert(d.message); return; }

  user.credit=d.credit;
  credit.innerText=d.credit;
  localStorage.setItem("user",JSON.stringify(user));
  alert("สั่งซื้อสำเร็จ");
}

/* ORDERS */
async function showOrders(){
  panel.style.display="none";
  ordersBox.style.display="block";
  await loadMyOrders();
  orderTimer=setInterval(loadMyOrders,5000);
}

async function loadMyOrders(){
  const data=await (await fetch(ORDERS_API)).json();
  const my=data.filter(o=>String(o.user_id)===String(user.user_id)).reverse();
  if(!my.length){ ordersList.innerText="ยังไม่มีออเดอร์"; return; }

  ordersList.innerHTML=my.map(o=>`
    <div class="order">
      <b>${o.platform} | ${o.service_code}</b><br>
      จำนวน: ${o.qty} | ${o.price} บาท<br>
      สถานะ: <span class="${o.status}">${o.status}</span><br>
      <span class="small">${o.created_at}</span>
    </div>
  `).join("");
}

function backToPanel(){ showPanel(); }
</script>