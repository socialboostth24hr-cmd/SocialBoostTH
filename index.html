<script>
// ================= CONFIG =================
const SHEET_ID = "10hFozE-vcdtPhX7KiGs3JTndpvxbUNDHDzhpvPxIz-4";
const USERS_API    = `https://opensheet.elk.sh/${SHEET_ID}/users`;
const SERVICES_API = `https://opensheet.elk.sh/${SHEET_ID}/services`;
const GAS_API =
"https://script.google.com/macros/s/AKfycbwWOaLikdxgXIpH9x9Xm5TY-ZJ-nElt8WHwriNypWlUEZbTu8FFlqWycvZW1r8ljTRu/exec";

// ================= STATE =================
let currentUser = null;
let services = [];

// ================= LOGIN =================
async function login(){
  loginMsg.innerText = "กำลังตรวจสอบ...";

  const emailVal = email.value.trim().toLowerCase();
  const passVal  = password.value.trim();

  const res = await fetch(USERS_API);
  const raw = await res.json();

  const users = raw.map(u => ({
    user_id: String(u.user_id||"").trim(),
    fullname: String(u.fullname||"").trim(),
    email: String(u.email||"").trim().toLowerCase(),
    password: String(u.password||"").trim(),
    credit: Number(String(u.credit||"0").trim())
  }));

  const u = users.find(r =>
    r.email === emailVal && r.password === passVal
  );

  if(!u){
    loginMsg.innerText = "อีเมลหรือรหัสผ่านไม่ถูกต้อง";
    return;
  }

  currentUser = u;
  localStorage.setItem("user", JSON.stringify(u));
  showPanel();
  loadServices();
}

function showPanel(){
  loginBox.style.display="none";
  panel.style.display="block";
  username.innerText = currentUser.fullname;
  credit.innerText   = currentUser.credit;
}

// ================= LOAD SERVICES =================
async function loadServices(){
  const res = await fetch(SERVICES_API);
  const data = await res.json();
  services = data.filter(s => s.status === "active");

  serviceSelect.innerHTML = `<option value="">-- เลือกบริการ --</option>`;
  services.forEach((s,i)=>{
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = `${s.platform} | ${s.service_name}`;
    serviceSelect.appendChild(opt);
  });
}

// ================= ORDER + หักเครดิต =================
async function order(){
  if(serviceSelect.value===""){
    alert("กรุณาเลือกบริการ");
    return;
  }

  const s = services[serviceSelect.value];
  const q = Number(qty.value);
  const total = q * Number(s.price_th);

  if(total > currentUser.credit){
    alert("เครดิตไม่พอ");
    return;
  }

  const res = await fetch(GAS_API,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      user_id: currentUser.user_id,
      amount: total
    })
  });

  const d = await res.json();

  if(!d.success){
    alert(d.message);
    return;
  }

  currentUser.credit = d.credit;
  localStorage.setItem("user", JSON.stringify(currentUser));
  credit.innerText = d.credit;

  alert("✅ หักเครดิตสำเร็จ");
}
</script>